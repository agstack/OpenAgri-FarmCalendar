{% extends "base.html" %}
{% load static %}

{% block title %}Calendar{% endblock title %}


{% block page_content_title %}Farm Calendar{% endblock %}

{% block page_content_rows %}

<div class="row">
  <div class="col-xl-12 col-lg-12">
    <div class="card shadow mb-4">
      <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">Farm Activities Calendar</h6>
        {% block card_header_action %}
        {% endblock %}
      </div>

      <div class="card-body">
        <div class="d-flex flex-wrap align-items-center mb-3 filter-container">
          <label for="activityFilter" class="mr-2 font-weight-bold">Filter by Type:</label>
          <button value="all" class="btn btn-outline-secondary btn-sm filter mr-2">All</button>
          <button value="00000000-0000-0000-0000-000000000002" class="btn btn-outline-secondary btn-sm filter mr-2">University</button>
          <button value="school" class="btn btn-outline-secondary btn-sm filter mr-2">School</button>
          <!-- Add more buttons as needed, values must match groupId fields -->
        </div>

        <a href="{% url 'create_activity_type' %}" class="btn btn-primary mb-3">Register New Calendar Activity Type</a>
        <a href="{% url 'pre_register_calendar_activity' %}" class="btn btn-primary mb-3">Register New Calendar Activity</a>
        <div id='calendar'></div>
      </div>
    </div>
  </div>
</div>

{% endblock %}


{% block on_dom_load_js %}
let calendar;
let allEvents = [];
let filter_option = "all";

const calendarEl = document.getElementById('calendar');

calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    timeZone: 'local',
    headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    height: 'auto',
    contentHeight: 'auto',
    defaultTimedEventDuration: '01:00',
    defaultAllDayEventDuration: { days: 1 },

    events: function(fetchInfo, successCallback, failureCallback) {
        let filtered = allEvents;
        if (filter_option !== "all") {
            filtered = allEvents.filter(event => event.activity_type_id === filter_option);
            console.log('here');
        }
        successCallback(filtered);
    },

    eventClick: function(info) {
        window.location.href = info.event.extendedProps.detail_url;
    }
});

calendar.render();

fetch("{% url 'calendar_activity_list' %}")
    .then(response => response.json())
    .then(data => {
        allEvents = data;
        calendar.refetchEvents();
    });

document.querySelectorAll(".filter-container .filter").forEach(el => {
    el.addEventListener("click", function() {
        filter_option = this.value;
        calendar.refetchEvents();
    });
});
{% endblock on_dom_load_js %}

{% block body_end_extra_scripts %}
<script src="{% static 'vendor/fullcalendar-6.1.15/dist/index.global.min.js' %}"></script>
{% endblock body_end_extra_scripts %}


